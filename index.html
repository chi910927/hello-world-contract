<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelloWorld 合約測試</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; line-height: 1.6; }
        h1, h2 { text-align: center; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        button, input { padding: 10px; margin-top: 10px; width: 100%; box-sizing: border-box; }
        #output { background-color: #f4f4f4; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .note { color: gray; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>HelloWorld 合約測試</h1>
    <div class="container">
        <p>這是一個簡單的網頁，用於測試已部署在 Sepolia 網路上的 HelloWorld 合約。</p>
        <hr>

        <h2>當前訊息</h2>
        <button id="connectBtn">連接 MetaMask</button>
        <pre id="messageOutput">尚未讀取訊息，請先連接錢包。</pre>

        <hr>

        <h2>更新訊息</h2>
        <input type="text" id="newMessageInput" placeholder="輸入新的訊息..." />
        <button id="updateBtn" disabled>更新訊息</button>
        <div class="note">⚠️ 此操作會發送一筆交易，需要支付 Gas 費用。</div>

        <hr>

        <h2>交易日誌</h2>
        <pre id="output">日誌會顯示在這裡。</pre>
    </div>

    <script>
        // 你的合約地址與 ABI
        const CONTRACT_ADDRESS = "0xAd46dc5e996b9958370E2c14A5D4efd2770d08b0"; // 請填入你的合約地址
        const CONTRACT_ABI = [
            // 請貼上你的合約 ABI
            { "inputs": [], "name": "message", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "string", "name": "_newMessage", "type": "string" }], "name": "updateMessage", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        // 定義 DOM 元素
        const connectBtn = document.getElementById("connectBtn");
        const updateBtn = document.getElementById("updateBtn");
        const messageOutput = document.getElementById("messageOutput");
        const newMessageInput = document.getElementById("newMessageInput");
        const output = document.getElementById("output");

        // 定義 Ethers 相關變數
        let provider, signer, contract;

        // 函式：顯示日誌訊息
        function log(message) {
            output.textContent += `${message}\n`;
            output.scrollTop = output.scrollHeight; // 自動滾動
        }

        // 函式：連接 MetaMask
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    log("錯誤: 請安裝 MetaMask 或其他支援 EIP-1193 的錢包。");
                    return;
                }

                log("正在請求連接 MetaMask...");
                // 請求使用者授權連接錢包
                await window.ethereum.request({ method: "eth_requestAccounts" });
                
                // 建立 Provider 與 Signer 實例
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                // 建立合約實例，並連接到 Signer (用於發送交易)
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                // 使用唯讀的 Provider 來呼叫 view 函式
                readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                log(`成功連接！錢包地址: ${await signer.getAddress()}`);
                
                connectBtn.textContent = "已連接";
                connectBtn.disabled = true;
                updateBtn.disabled = false;

                // 成功連接後，立即讀取並顯示訊息
                await getMessage();

            } catch (error) {
                log(`連接失敗: ${error.message}`);
            }
        }

        // 函式：讀取合約訊息
        async function getMessage() {
            try {
                // const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const message = await readOnlyContract.message();
                messageOutput.textContent = `"${message}"`;
                log("成功讀取當前訊息。");
            } catch (error) {
                log(`讀取訊息失敗: ${error.message}`);
            }
        }

        // 函式：更新合約訊息
        async function updateMessage() {
            try {
                const newMessage = newMessageInput.value;
                if (!newMessage) {
                    log("請輸入要更新的訊息。");
                    return;
                }
                
                log(`正在發送交易，將訊息更新為: "${newMessage}"`);

                // 使用已連接 Signer 的合約實例來發送交易
                const tx = await contract.updateMessage(newMessage);
                log(`交易 Hash: ${tx.hash}`);

                // 等待交易被區塊鏈確認
                log("等待交易確認...");
                await tx.wait();
                log("✅ 交易確認完畢！");

                // 交易成功後，再次讀取並更新顯示
                await getMessage();

            } catch (error) {
                log(`交易失敗: ${error.message}`);
            }
        }

        // 監聽按鈕點擊事件
        connectBtn.addEventListener("click", connectWallet);
        updateBtn.addEventListener("click", updateMessage);

        // 頁面載入後，顯示提示
        document.addEventListener("DOMContentLoaded", () => {
            log("請點擊『連接 MetaMask』按鈕，開始測試。");
        });

    </script>
</body>
</html>
